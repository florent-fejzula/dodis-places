<div class="container">
  <header class="app-header">
    <div class="header-inner">
      <h1 class="title">Dodi’s Places</h1>
      <p class="tagline">
        Find the most beautiful cafés, desserts, and food spots in Skopje —
        visually.
      </p>
    </div>
  </header>

  <app-tags-section
    [locationTags]="locationTags"
    [vibeTags]="vibeTags"
    [stuffTags]="stuffTags"
    [selectedTags]="selectedTags"
    [disabledTags]="disabledTags"
    (tagClicked)="onTagClicked($event)"
    (clearClicked)="clearSelectedTags()"
  ></app-tags-section>

  <!-- Results bar / Empty state -->
  <div class="results-bar" *ngIf="filteredPlaces.length > 0" aria-live="polite">
    {{ filteredPlaces.length }}
    {{ filteredPlaces.length === 1 ? "place" : "places" }} found
  </div>

  <!-- Cards -->
  <div class="cards" (click)="closeMenu()">
    <div
      class="card"
      *ngFor="let p of filteredPlaces; let i = index"
      [style.--i]="i"
      (click)="$event.stopPropagation()"
    >
      <button
        class="fav-btn"
        (click)="toggleFavorite(p)"
        [class.active]="isFavorite(p)"
        aria-label="Save to favorites"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path
            d="M20.8 4.6a5.5 5.5 0 0 0-7.8 0L12 5.6l-1-1a5.5 5.5 0 0 0-7.8 7.8l1 1L12 21l7.8-7.6 1-1a5.5 5.5 0 0 0 0-7.8z"
          />
        </svg>
      </button>
      <button
        *ngIf="isAdmin"
        type="button"
        class="card-menu"
        aria-label="Open actions"
        aria-haspopup="true"
        [attr.aria-expanded]="menuOpenFor?.id === p.id"
        (click)="openMenu(p, $event)"
      >
        ⋮
      </button>

      <div
        class="menu"
        *ngIf="menuOpenFor?.id === p.id"
        role="menu"
        (click)="$event.stopPropagation()"
      >
        <button type="button" role="menuitem" (click)="goEdit(p)">Edit</button>
        <button
          type="button"
          role="menuitem"
          class="danger"
          (click)="confirmDelete(p)"
        >
          Delete
        </button>
      </div>

      <div class="media" *ngIf="getImage(p) as img; else noimg">
        <img [src]="img" [alt]="p.name" loading="lazy" />
      </div>
      <ng-template #noimg>
        <div class="media placeholder">No image</div>
      </ng-template>

      <div class="body">
        <h3>{{ p.name }}</h3>
        <div class="tags">
          <span class="pill" *ngFor="let t of p.tags | slice : 0 : 6">{{
            t
          }}</span>
        </div>
        <button class="link" type="button" (click)="openInMaps(p)">
          Open in Google Maps
        </button>
      </div>
    </div>
  </div>

  <!-- Map -->
  <div class="map-wrap" *ngIf="apiReady">
    <google-map
      height="60vh"
      width="100%"
      [center]="center"
      [zoom]="zoom"
      [options]="mapOptions"
    >
      <map-marker
        *ngFor="let p of filteredPlaces"
        #m="mapMarker"
        [position]="{ lat: p.lat, lng: p.lng }"
        [title]="p.name"
        (mapClick)="openInfo(m, p)"
      ></map-marker>

      <map-info-window>
        <div class="iw">
          <div class="iw-title">{{ selectedPlace?.name }}</div>
          <div class="iw-tags" *ngIf="selectedPlace?.tags?.length">
            <span class="pill" *ngFor="let t of selectedPlace?.tags">{{
              t
            }}</span>
          </div>
          <a class="iw-link" (click)="openInMaps(selectedPlace!)"
            >Open in Google Maps</a
          >
        </div>
      </map-info-window>
    </google-map>
  </div>
</div>
